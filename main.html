<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Login</title>
    <meta charset="utf-8">


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-teal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!--    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    -->
    <script type="text/javascript" src="js/qrcode.js"></script>
    <style>

        .container1 {
            width: 100%;
            min-height: 100vh;
            # display: -webkit-flex;
            # display: -moz-box;
            # display: -ms-flexbox;
            # display: flex;
            # flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 1px;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            background: #224688;
        }

        .header1 {
            background-color: #2957a3;
            color: #ededed;
        }

        .header2 {
            background-color: #3984ec;
            color: #ededed;
        }

        .logoutButton {
            width: 80px;;
            margin: 0px;
            font-size: 20px
        }

        .couponTable {
        }

        .gi-2x {
            font-size: 2em;
        }

        .gi-3x {
            font-size: 3em;
        }

        .gi-4x {
            font-size: 4em;
        }

        .gi-5x {
            font-size: 5em;
        }

        #formId {
            #display: none;
            width: 100%;
            visibility: hidden;
        }

        .qrCodePane {
            visibility: hidden;
            # display: none;
            top: 10px;
            width: 50%;
            right-margin: 10px
        }

        .qrCod e {
            height: 100px;
            width: 100px;
        }

        .qrCode {
            width: 148px;
            height: 150px;
            border-width: 10px;
            border-style: solid;
            border-color: white;
            background-color: white;
            color: #000;

            margin-right: 180px;
            visibility: hidden;
        }

        #output {

        }

        .buttonTable {
            margin-leftt: 0;
            height: 30px;
        }

        .qrCodeButton {
            color: #000;
            font-size: 30px;
            padding-right: 10px;

        }

        .qrCodePrintButton {
            color: black;
            padding-right: 10px;
            font-size: 30px;
        }

        .getAllButton {
            color: black;
            padding-right: 10px;
            font-size: 30px;
        }

        td:first-child {
            padding-left: 4px;
        }

        .couponTable tr td {
            width: 16.6%;
        }

        .createCouponRow td {
            padding-right: 2px;
            padding-left: 2px;
            width: 16.6%;
            margin-left: 100px;
        }

        .emtpy {
            width: 16.6%;
        }

        .createBtn {
            #width: 16.6%;
        }

        #firstChild {
            padding-left: 2px;
        }

    </style>
</head>

<body>

<div class="container1"> <!-- style="background-image: url('/img/background.jpg');"> -->

    <div class=" header1 w3-container w3-padding-small">
        <div class=" malinko  w3-right">
            <i class="fa fa-volume-up"></i>
            <i class="fa fa-wifi"></i>
            <i class="fa fa-battery-2"></i>
            12:30
        </div>
    </div>

    <div class=" header2 w3-bar  w3-xlarge">
        <a class="w3-bar-item w3-button" href="#"><i class="fa fa-bars"></i></a>
        <span class="w3-bar-item">Vedetten Admin</span>
        <button class=" logoutButton w3-bar-item w3-button w3-right" onclick="logout()">Logout</button>
    </div>

    <div class="w3-bar w3-theme">

    </div>

    <div class="w3-row">
        <div class="w3-col" style="width:10%"><p>20%</p></div>
        <div class="w3-col" style="width:80%">

            <h2>Coupons</h2>
            <table id="couponTable" class=" couponTable w3-table-all w3-hoverable">
                <thead>
                <tr>
                    <th>Namn</th>
                    <th>ID</th>
                    <th>Betala</th>
                    <th>Balans</th>
                    <th>QR Kod</th>
                    <th>Delete</th>
                </tr>
                </thead>
                <tr>
                <tr id="1004">
                    <td>John</td>
                    <td>1004</td>
                    <td>40</td>
                    <td>-150</td>
                    <td>
                        <button onclick="showQRcode('1004')" class="glyphicon glyphicon-qrcode"></button>
                    </td>
                    <td>
                        <button onclick="destroyCoupon()" class="glyphicon glyphicon-trash"></button>
                    </td>
                </tr>
                <tr id="1014">
                    <td>Nisse</td>
                    <td>1014</td>
                    <td>40</td>
                    <th>100</th>
                    <td>
                        <button onclick="showQRcode('1014')" class="glyphicon glyphicon-qrcode"></button>
                    </td>
                    <td>
                        <button onclick="destroyCoupon()" class="glyphicon glyphicon-trash"></button>
                    </td>
                </tr>
                <tr id="1003">
                    <td>Lars</td>
                    <td>1003</td>
                    <td>20</td>
                    <td>-80</td>
                    <td>
                        <button onclick="showQRcode('1003')" class="glyphicon glyphicon-qrcode"></button>
                    </td>
                    <td>
                        <button onclick="destroyCoupon()" class="glyphicon glyphicon-trash"></button>
                    </td>
                </tr>
                <tr id="1001">
                    <td>Malin</td>
                    <td>1001</td>
                    <td>20</td>
                    <td>80</td>
                    <td>
                        <button onclick="showQRcode('1001')" class="glyphicon glyphicon-qrcode"></button>
                    </td>
                    <td>
                        <button onclick="destroyCoupon()" class="glyphicon glyphicon-trash"></button>
                    </td>
                </tr>

                <form id="formId">
                    <table class="w3-table-all">
                        <tr class="createCouponRow">
                            <td id="firstChild">
                                <input CLASS="w3-input w3-border" name="name" type="text" placeholder="Namn"
                                       onkeypress="myFunction(this.value)">
                            </td>
                            <td>
                                <input class="w3-input w3-border" name="couponId" type="text" placeholder="Id nummer"
                                       onkeypress="myFunction(this.value)">
                            </td>
                            <td>
                                <input class="w3-input w3-border" name="pay" type="text" placeholder="Amout"
                                       onkeypress="myFunction(this.value)">

                            </td>
                            <td>
                                <input class="w3-input w3-border" name="balance" type="text" placeholder="Balans"
                                       onkeypress="myFunction(this.value)">

                            <td class="emtpy"></td>

                            <td>
                                <button class=" createBtn w3-input w3-border w3-button  w3-blue " type="submit"> Skapa
                                </button>
                            </td>
                        </tr>
                    </table>
                </form>

                <div class="w3-display-container w3-blue" style="height:40px;">

                    <table class="buttonTable  w3-display-topright">
                        <tr class="">

                            <td class="qrCodeButton ">
                                <button class="  glyphicon glyphicon-qrcode" onclick="showQRcode('9999')"></button>
                            </td>

                            <td class="qrCodePrintButton " id="qrCodePrint">
                                <button onclick="printQRcode()" class="glyphicon glyphicon-print "></button>
                            </td>
                            <td class="getAllButton " id="getAll">
                                <button onclick="getAllCoupons()" class="glyphicon glyphicon-repeat  "></button>
                            </td>

                        </tr>
                    </table>
                    <div id="qrCode" class=" qrCode w3-display-topright ">
                        <div class=" " id="output"></div>
                    </div>
                </div>

            </table>
        </div>
        <div class="w3-col" style="width:10%">
        </div>


        <div class="w3-col" style="width:20%">

        </div>

        <script type="text/javascript" src="/js/qrcode.js"></script>
        <script>

            function printQRcode() {
                var canvas = document.querySelector("#output canvas");
                var img = canvas.toDataURL("image/png");
                printImage(img);
            }

            function destroyCoupon() {
                window.alert("couponDestroy");
            }

            function printImage(src) {
                var win = window.open('', "_new");
                win.document.open();
                win.document.write([
                    '<html>',
                    '   <head>',
                    '   </head>',
                    '   <body onload="window.print()" onafterprint="window.close()">',
                    '       <img src="' + src + '"/>',
                    '   </body>',
                    '</html>'
                ].join(''));
                win.document.close();
            }

            var qrcode = null;

            function showQRcode(id) {
                document.getElementById("qrCode").style.visibility = "visible";
                var t = new Date();
                var fullDate = t.getFullYear() + "-" + t.getMonth() + "-" +
                    t.getDay() + " " + t.getHours() + ":" + t.getMinutes();
                var JObj;
                if (id != "9999") {
                    var row = document.getElementById(id);
                    JObj = {
                        name: row.cells[0].innerHTML,
                        Id: row.cells[1].innerHTML,
                        Pay: row.cells[2].innerHTML,
                        Issued: fullDate
                    };
                } else {
                    var e = document.getElementById("formId").elements;
                    var n = e.namedItem("name").value;
                    var idNumber = e.namedItem("couponId").value;
                    var pay = e.namedItem("pay").value;
                    var Balance = e.namedItem("balance").value;
                    JObj = {
                        name: n,
                        Id: idNumber,
                        Pay: pay,
                        Balance: Balance,
                        Issued: fullDate
                    };
                }
                //Balans : row.cells[3].innerHTML };
                Jstring = JSON.stringify(JObj);
                var elem = document.getElementById('output');
                elem.textContent = "";

                if (qrcode != null) {
                    qrcode.clear();
                }
                qrcode = new QRCode("output", {
                    text: Jstring,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            function createCoupon() {
                if (document.getElementById("formId").style.visibility == "visible") {
                    document.getElementById("formId").style.visibility = "hidden";

                } else {
                    document.getElementById("formId").style.visibility = "visible";
                }
            }

            function create() {
                document.getElementById("formId").style.visibility = "hidden"
            }

            function URL() {
                // return "{{.Protocol}}://{{.Host}}:{{.Port}}";
                return "https://qr.rakuen.tokyo:7777"
            }

            function myFunction(value) {
                showQRcode("9999");
            }

            window.addEventListener("load", function () {
                document.getElementById('formId').addEventListener("submit", function (e) {
                    e.preventDefault(); // before the code
                    submitForm();
                });
            });

            function populateCouponTable(elems) {
                var i = 0;

                alert("table length " + elems.coupons.length)

                var table = document.getElementById("couponTable");

                while (table.hasChildNodes()) {
                    table.removeChild(table.lastChild);
                }

                for (i = 0; i < elems.coupons.length; i++) {
                    var row = table.insertRow(0);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    var cell5 = row.insertCell(4);
                    var cell6 = row.insertCell(5);
                    cell1.innerHTML = elems.coupons[i].firstName;
                    cell2.innerHTML = elems.coupons[i].couponId;
                    cell3.innerHTML = elems.coupons[i].pay;
                    cell4.innerHTML = elems.coupons[i].balance;
                    cell5.innerHTML = "";
                    cell6.innerHTML = "";
                }
            }


            function submitForm() {
                const formData = new FormData(document.getElementById("formId"));
                let jsonObject = {};
                for (const [key, value] of formData.entries()) {
                    jsonObject[key] = value;
                }
                jsonObject["op"] = "createCoupon";
                //var form_data = $("#formId").serialize();
                alert(JSON.stringify(jsonObject));
                $.ajax({
                    url: URL() + "/CouponManager",
                    type: "post",
                    async: "true",
                    data: JSON.stringify(jsonObject),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (response) {
                        alert("success " + response.status);
                        console.log("submitForm " + response.status);
                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                        console.log("Error: ");
                        alert("ERROR");
                    }
                }).done(function (response) {
                    console.log("submitForm " + response.status);
                    alert("done success " + response.status);
                });
            }

            function getAllCoupons() {
                var request = new XMLHttpRequest();
                request.open("POST", URL() + "/GetAllCoupons", true);
                request.setRequestHeader('Content-Type', 'application/json');
                request.send(JSON.stringify(""));
                request.onload = function () {
                    if (request.status == 200) {
                        json_response = JSON.parse(request.response);
                        if (json_response.status.status != "SUCCESS") {
                            alert("getAllCoupons() returned " + json_response.status.status + ++
                                json_response.detail);
                            return null;
                        }
                        alert("getAllCoupons() SUCCESS " + json_response.coupons[0].firstName);
                        populateCouponTable(json_response);
                    } else {
                        console.log("getUser problem " + status);
                        alert("getAllCoupons() ERROR");
                    }
                }
            }

            function logoutAction(op) {
                alert("here1");
                var request = new XMLHttpRequest();
                request.open("POST", URL() + "/logout", true);
                request.onload = function () {
                    alert("here2");
                    status = request.status;
                    if (status == 200) {
                        window.location = URL() + "/";
                    } else {
                        console.log("logoutAction problem " + status)
                    }
                };
                request.send();
            }

            function logout() {
                logoutAction("logout");
            }

        </script>
</body>
</html>
<!--
                        <button class=" addCoupon w3-button w3-hover-red glyphicon glyphicon-plus"
                                onclick="createCoup"></button>
                        <!--
                                        <form id="formId2" method="post"
                                              class="formClass w3-container w3-card-4 w3-light-grey w3-text-blue w3-margin">
                                            <h2 class="w3-center">Skapa en kupong</h2>

                                            <div class="w3-row w3-section">
                                                <div class="w3-col" style="width:50px"><i class="w3-xxlarge fa fa-user"></i></div>
                                                <div class="w3-rest">
                                                    <input class="w3-input w3-border" name="Name" type="text" placeholder="Namn">
                                                </div>
                                            </div>

                                            <div class="w3-row w3-section">
                                                <div class="w3-col" style="width:50px"><i class="w3-xxlarge glyphicon glyphicon-info-sign"></i>
                                                </div>
                                                <div class="w3-rest">
                                                    <input class="w3-input w3-border" name="IdNumber" type="text" placeholder="Id nummer">
                                                </div>
                                            </div>

                                            <div class="w3-row w3-section">
                                                <div class="w3-col" style="width:50px"><i class="w3-xxlarge glyphicon glyphicon-cutlery"></i>
                                                </div>
                                                <div class="w3-rest">
                                                    <input class="w3-input w3-border" name="Balance" type="text"
                                                           placeholder="Inbetalt">
                                                </div>
                                            </div>

                                            <div class="w3-row w3-section">
                                                <div class="w3-col" style="width:50px"><i class="w3-xxlarge glyphicon glyphicon-lock"></i></div>
                                                <div class="w3-rest">
                                                    <input class="w3-input w3-border" name="phone" type="text" placeholder="Pin kod">
                                                </div>
                                            </div>

                        </span>
                                            <button onclick="submitForm()" hidden class="w3-button w3-block w3-section w3-blue w3-ripple w3-padding">
                                                Skapa
                                            </button>
                                        </form>
                                        -->